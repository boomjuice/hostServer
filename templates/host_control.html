{% extends 'index.html' %}
{% block right-content %}
    {% csrf_token %}
    <div class="row">
        <div class="col-lg-4">
            <div class="box box-solid ">
                <div class="box-header with-border">
                    <h3 class="box-title">可管理主机组</h3>
                    <div class="box-tools pull-right">
                        <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>
                </div><!-- /.box-header -->
                <div class="box-body">
                    <div class="box-group" id="accordion">
                        {% for host_groups in request.user.host_groups.all %}
                            <div class="panel box box-primary">
                            <div class="box-header with-border">
                                <h4 class="box-title" style="display: block">
                                    <span onclick="Toggle(this)" style="cursor: pointer;">{{ host_groups }}</span>
                                    <small class="label  bg-yellow  pull-right"
                                           onclick="CheckAll(this)">{{ host_groups.host_to_remote_users.count }}</small>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse in">
                                <div class="box-body">
                                    <ul>
                                        {% for host_to_obj in host_groups.host_to_remote_users.all %}
                                            <li><input type="checkbox" name="{{ host_to_obj.id }}" tag="tag">
                                                {{ host_to_obj.host.name }} ({{ host_to_obj.host.ip_address }})
                                                @ {{ host_to_obj.remote_user.username }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endfor %}
                        <div class="panel box box-success">
                            <div class="box-header with-border">
                                <h4 class="box-title" style="display: block">
                                    <span onclick="Toggle(this)" style="cursor: pointer;">未分组主机</span>
                                    <small class="label  bg-yellow  pull-right"
                                           onclick="CheckAll(this)">{{ request.user.host_to_remote_users.count }}</small>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse in">
                                <div class="box-body">
                                    <ul>
                                        {% for host_to_obj in request.user.host_to_remote_users.all %}
                                            <li><input type="checkbox" name="{{ host_to_obj.id }}" tag="tag">
                                                {{ host_to_obj.host.name }} ({{ host_to_obj.host.ip_address }})
                                                @ {{ host_to_obj.remote_user.username }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="box box-solid ">
            <div class="box-header with-border">
                <h3 class="box-title">命令操作</h3>
                <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                </div>
            </div><!-- /.box-header -->
            <div class="box-body">
                <textarea name="cmd" id="cmd_input" rows="2" class="form-control"></textarea>
                <button class="btn bg-purple btn-flat margin pull-right" onclick="return AjaxCmd()">执行命令</button>
            </div>
        </div>
    </div>
    <script>
        function Toggle(ele) {
            $(ele).parent().parent().next().find('ul').fadeToggle()
        }

        function CheckAll(ele) {
            $(ele).parent().parent().next().find('input').each(function () {
                if (!$(this).prop('checked')) {
                    $(this).prop('checked', true)
                } else {
                    $(this).prop('checked', false)
                }
            })
        }

        function AjaxCmd() {
            var selected_ids = [];
            var cmd_text = $('#cmd_input').val().trim();
            var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
            $('[tag="tag"]:checked').each(function () {
                selected_ids.push($(this).attr('name'));
            });
            if (selected_ids.length == 0) {
                alert('请勾选主机');
                return false
            }
            if (cmd_text.length == 0) {
                alert('请输入命令');
                return false
            }
            var task_arguments = {
                'task_type': 'cmd',
                'cmd': cmd_text,
                'selected_host': selected_ids

            };
            $.post("{% url 'batch_cmd_control' %}",
                {'task_arguments': JSON.stringify(task_arguments), 'csrfmiddlewaretoken': csrf_token,},
            function (callback) {

            })
        }
    </script>
{% endblock %}